<?xml version="1.0" encoding="UTF-8"?>

<!--
 Copyright 2006 The Apache Software Foundation.

 Licensed under the Apache License, Version 2.0 (the "License")
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->

<project name="velocity-docbook" default="all" basedir=".">

  <!-- Load our properties -->
  <property file="project.properties"/>

  <!-- ======================================================================== -->
  <!-- ==                                                                    == -->
  <!-- == Set up the classpath for the XSLT conversion                       == -->
  <!-- ==                                                                    == -->
  <!-- ======================================================================== -->
  <path id="docbook.classpath">
    <fileset dir="${basedir}/lib">
      <include name="*.jar"/>
    </fileset>
    <fileset dir="${docbook.xsl.dir}/extensions">
      <include name="${xslt-db.jar}"/>
    </fileset>
    <pathelement location="${basedir}"/>
  </path>

  <!-- ======================================================================== -->
  <!-- ==                                                                    == -->
  <!-- == Prepare Path elements to be used when filtering the XSL files      == -->
  <!-- ==                                                                    == -->
  <!-- ======================================================================== -->
  <path id="docbook.xml.path" location="${docbook.xml.dir}"/>
  <path id="docbook.xsl.path" location="${docbook.xsl.dir}"/>
  <path id="src.dir.path" location="${src.dir}"/>
  <path id="tmp.dir.path" location="${tmp.dir}"/>
  <pathconvert dirsep="/" property="docbook.xml.path" refid="docbook.xml.path"/>
  <pathconvert dirsep="/" property="docbook.xsl.path" refid="docbook.xsl.path"/>
  <pathconvert dirsep="/" property="src.dir.path" refid="src.dir.path"/>
  <pathconvert dirsep="/" property="tmp.dir.path" refid="tmp.dir.path"/>

  <condition  property="file.prefix" value="file:///">
    <os family="windows"/>
  </condition>
  <condition  property="file.prefix" value="file://">
    <os family="unix"/>
  </condition>

  <!-- This filterset is used to convert the style sheets to reference
       the actual locations of the docbook XSLT files -->
  <filterset id="filterset.docbook.location">
    <filter token="paper.type" value="${paper.type}" />
    <filter token="file.prefix" value="${file.prefix}" />
    <filter token="docbook.xml" value="${docbook.xml.path}" />
    <filter token="docbook.xsl" value="${docbook.xsl.path}" />
    <filter token="src.dir" value="${src.dir.path}" />
    <filter token="tmp.dir" value="${tmp.dir.path}" />
  </filterset>

  <!-- ======================================================================== -->
  <!-- ==                                                                    == -->
  <!-- == Saxon Converter macro that uses commons-resolver                   == -->
  <!-- ==                                                                    == -->
  <!-- == input: The file to transform                                       == -->
  <!-- == output: The transformation result                                  == -->
  <!-- == style: The Style Sheet used for the transformation                 == -->
  <!-- ==                                                                    == -->
  <!-- ======================================================================== -->
  <macrodef name="saxon">
    <attribute name="input"/>
    <attribute name="output"/>
    <attribute name="style"/>
    <sequential>
      <java classname="com.icl.saxon.StyleSheet" fork="true"
            dir="${basedir}" classpathref="docbook.classpath">
        <arg line="-x org.apache.xml.resolver.tools.ResolvingXMLReader"/>
        <arg line="-y org.apache.xml.resolver.tools.ResolvingXMLReader"/>
        <arg line="-r org.apache.xml.resolver.tools.CatalogResolver"/>
        <arg value="-o"/>
        <arg value="@{output}"/>
        <arg value="@{input}"/>
        <arg value="@{style}"/>
      </java>
    </sequential>
  </macrodef>

  <!-- ======================================================================== -->
  <!-- ==                                                                    == -->
  <!-- == Transformation Macro that generates output from Docbook            == -->
  <!-- ==                                                                    == -->
  <!-- == type: Type of transformation (pdf, html, htmlsingle)               == -->
  <!-- == title: Titlepage to use (html and htmlsingle both use html!)       == -->
  <!-- == target: Target directory (pdf needs tmp for FOP transform)         == -->
  <!-- == dir: Subdir where the Docbook XML file is located. Also subdir     == -->
  <!-- ==      for the output                                                == -->
  <!-- == file: Name of the file (without ending!) to transform              == -->
  <!-- ==                                                                    == -->
  <!-- ======================================================================== -->
  <macrodef name="transform">
    <attribute name="type"/>
    <attribute name="title"/>
    <attribute name="target"/>
    <attribute name="dir"/>
    <attribute name="file"/>
    <sequential>

    <property name="@{type}.target.dir" value="${target.dir}/@{dir}/@{target}"/>
    <property name="@{type}.target.file" value="${@{type}.target.dir}/@{file}"/>
    <property name="@{type}.tmp.style" value="${tmp.dir}/@{type}.xsl"/>

    <path id="@{type}.target.path" location="${@{type}.target.dir}"/>
    <pathconvert dirsep="/" property="@{type}.target.path" refid="@{type}.target.path"/>

    <copy overwrite="true" filtering="on" file="${style.src.dir}/@{type}.xsl" tofile="${@{type}.tmp.style}">
      <filterset refid="filterset.docbook.location"/>
      <filterset>
        <filter token="@{type}.target.dir" value="${@{type}.target.path}" />
      </filterset>
    </copy>

    <mkdir dir="${@{type}.target.dir}/" />

    <saxon input="${src.dir}/styles/@{title}/titlepage.xml"
           output="${tmp.dir}/@{title}-titlepage.xsl"
           style="${docbook.xsl.dir}/template/titlepage.xsl"/>

    <copy todir="${@{type}.target.dir}/images">
      <fileset dir="${src.dir}/images"/>
    </copy>

    <saxon input="${docbook.src.dir}/@{dir}/@{file}.xml"
           output="${@{type}.target.file}.xml"
           style="${@{type}.tmp.style}"/>

    </sequential>
  </macrodef>  
  
  <!-- =========================================================================== -->
  <!-- ==                                                                       == -->
  <!-- == prepare temporary directories and unzip the docbook DTD and XSL files == -->
  <!-- ==                                                                       == -->
  <!-- =========================================================================== -->
  <target name="prepare">

    <fail message="You must set docbook.file and docbook.dir!">
      <condition>
        <not>
          <and>
            <isset property="docbook.dir"/>
            <isset property="docbook.file"/>
          </and>
        </not>
      </condition>
    </fail>

    <mkdir dir="${tmp.dir}" />

  	<available file="${docbook.xml.dir}" property="docbook.ref.unzipped.already" />
  	
  	<antcall target="unzip_docbook_ref"/>
  </target>

	<target name="unzip_docbook_ref" 
	        description="internal: unzips docbook xml and xsl style sheets"
	        unless="docbook.ref.unzipped.already">
    <mkdir dir="${docbook.xml.dir}" />
    <unzip src="${zip.src.dir}/docbook-xml-${docbook.xml.version}.zip" dest="${docbook.xml.dir}" />

    <mkdir dir="${docbook.xsl.dir}" />
    <unzip src="${zip.src.dir}/docbook-xsl-${docbook.xsl.version}.zip" dest="${docbook.ref.dir}" />
	</target>
		
  <!-- ======================================================================== -->
  <!-- ==                                                                    == -->
  <!-- == This is the main target to generate all the docs                   == -->
  <!-- ==                                                                    == -->
  <!-- ======================================================================== -->
  <target name="all" depends="pdf,html,htmlsingle"
          description="--> Generate and copy reference documentation"/>

  <!-- ======================================================================== -->
  <!-- ==                                                                    == -->
  <!-- == Clean up the target directory                                      == -->
  <!-- ==                                                                    == -->
  <!-- ======================================================================== -->
  <target name="clean"
          description="--> Delete temporary and distribution directories for docs">
    <delete quiet="true" dir="${target.dir}"/>
  </target>

  <!-- ======================================================================== -->
  <!-- ==                                                                    == -->
  <!-- == Create the PDF documentation                                       == -->
  <!-- ==                                                                    == -->
  <!-- ======================================================================== -->
  <target name="pdf"
          depends="prepare"
          description="--> Generate PDF docs">

    <transform type="pdf" target="tmp" title="pdf" dir="${docbook.dir}" file="${docbook.file}"/>

    <mkdir dir="${target.dir}/${docbook.dir}/pdf"/>

    <java classname="org.apache.fop.apps.Fop" fork="true" maxmemory="256m"
          dir="${basedir}" classpathref="docbook.classpath">
      <arg value="${pdf.target.file}.xml"/>
      <arg value="${target.dir}/${docbook.dir}/pdf/${docbook.file}.pdf"/>
    </java>
  </target>

  <!-- ======================================================================== -->
  <!-- ==                                                                    == -->
  <!-- == Create the HTML documentation, many pages                          == -->
  <!-- ==                                                                    == -->
  <!-- ======================================================================== -->
  <target name="html"
          depends="prepare"
          description="--> Generate HTML docs in multiple files">

    <transform type="html" target="html" title="html" dir="${docbook.dir}" file="${docbook.file}"/>

    <copy todir="${html.target.dir}/images">
      <fileset dir="${docbook.xsl.dir}/images/"/>
    </copy>

    <copy todir="${html.target.dir}/css">
      <fileset dir="${src.dir}/css/html"/>
    </copy>

    <delete file="${html.target.file}.xml"/>

    <delete quiet="true" file="${html.target.file}.zip"/>
    <zip basedir="${target.dir}/${docbook.dir}" destfile="${html.target.file}.zip">
      <include name="html/**"/>
    </zip>
  </target>

  <!-- ======================================================================== -->
  <!-- ==                                                                    == -->
  <!-- == Create the HTML documentation, one big page                        == -->
  <!-- ==                                                                    == -->
  <!-- ======================================================================== -->
  <target name="htmlsingle" 
          depends="prepare"
          description="--> Generate HTML docs in a single, big file">

    <transform type="htmlsingle" target="htmlsingle" title="html" dir="${docbook.dir}" file="${docbook.file}"/>

    <copy todir="${htmlsingle.target.dir}/images">
      <fileset dir="${docbook.xsl.dir}/images/"/>
    </copy>

    <copy todir="${htmlsingle.target.dir}/css">
      <fileset dir="${src.dir}/css/html"/>
    </copy>

    <move file="${htmlsingle.target.file}.xml" tofile="${htmlsingle.target.file}.html"/>

    <delete quiet="true" file="${htmlsingle.target.file}.zip"/>
    <zip basedir="${target.dir}/${docbook.dir}" destfile="${htmlsingle.target.file}.zip">
      <include name="htmlsingle/**"/>
    </zip>

  </target>
</project>
